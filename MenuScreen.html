<!DOCTYPE html>
<html id="HtmlContents">
    <head>
        <link rel="stylesheet" type="text/css" href="/GeneralStyles.css">
        <link rel="stylesheet" type="text/css" href="/CardStyle.css">
        <link rel="text" type="text" href="/MainPageHTMLText.txt">
        <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    </head>
    <body id="MainBody">
        <div id="MainBodyContents">
        <div id="CustomGameForm" method="POST" action="/startCustomGame" hidden="true">
            <p>Choose the amount of cards you want</p>
            <input id="CustomCardRange" type="range" min="1" max="100" value="1" name="cardAmount" oninput="this.nextElementSibling.value = this.value">
            <output>1</output>
            <button onclick="StartCustomGame()">Create Game</button>
        </div>
        <!--Change how games start to adjust for readying up-->
        <div id="LevelsForm">
            <div id="LevelButtons" hidden="true">
                <p>What level do you want to play?</p>
                <button  onclick="StartGameFromLevel(10)" value="10">Level 10</button>
                <button  onclick="StartGameFromLevel(9)" value="9">Level 9</button>
                <button  onclick="StartGameFromLevel(8)" value="8">Level 8</button>
                <button  onclick="StartGameFromLevel(7)" value="7">Level 7</button>
                <button  onclick="StartGameFromLevel(6)" value="6">Level 6</button>
                <button  onclick="StartGameFromLevel(5)" value="5">Level 5</button>
                <button  onclick="StartGameFromLevel(4)" value="4">Level 4</button>
                <button  onclick="StartGameFromLevel(3)" value="3">Level 3</button>
                <button  onclick="StartGameFromLevel(2)" value="2">Level 2</button>
                <button  onclick="StartGameFromLevel(1)" value="1">Level 1</button>
            </div>
        </div> 
        <div id="FullGameForm" hidden="true">
            <p>Click here to play a full run</p>
            <button onclick="StartFullGame()" value="1">Start Run</button>
        </div>
        <button id="PlayButton" hidden="true">Play Game</button>
        <p id="WinStatus">Win text goes here</p>

        <div id="MakeServerForm">
            <p>Enter a server Name here</p>
            <input type="text" placeholder="Enter server name here" id="MakeServerInput">
            <input type="button" value="Make new server" name="MakeServer" onclick="SetServerName()">
        </div>
        <div id="EmailContainer">
            <label>You are inviting everyone below</label>
            <ul id="Emails"></ul>
            <input id="EmailInput" type="text" placeholder="Enter email here">
            <input type="button" value="Add Email" onclick="AddEmail()">
            <label>What do you want to say?</label>
            <input id="EmailBody" type="text" placeholder="Enter what you want to say in your invite?">
            <input type="button" value="Send Invite" onclick="SendEmailInvite()">
        </div>

        <div id="UserNameMaker">
            <input type="text" id="UserNameInput" placeholder="Enter the username you want to use here.">
            <button onclick="SetUserName()">Set Username</button>
        </div>
        <button id="ReadyButton" onclick="CheckForStartGame()" hidden="true">Click to ready up</button>
       <!-- <div id="SearchDropdown">
            <button id="DropdownButton" onclick="ClearSearch()">Clear Search</button>
            <div id="SearchMenu" class="SearchContents">
                <input type="text" id="SearchBar" onkeyup="GetServersForSearch()" onfocus="GetServersForSearch()" placeholder="Search Servers">
                <div id="SearchResults">
                    
                </div>
            </div>
        </div>
       -->
        <main>
            <p id="UsernameDisplay">Your Username: </p>
            <p id="ServerNameDisplay">Current Server: </p>
            <p id="HostDisplay">Host's name: </p>
            <div id="MessageBox">
            </div>
            
        </main>
        <form id="MessageForm">
            <input type="text" id="InputBox"  value="">
            <input type="submit"  value="Send" style="transform: translate(800px, -15%); margin-top: 8%; margin-left: 7%;">
        </form>
        </div>
        <!--Server/Messaging script-->
       <script src="/SetupWinText.js"></script>
       <script src="/CardCode.js"></script>
       <script src = "/socket.io/socket.io.js"></script>
        <script>
            
            let socket = io();
            var userName = "";
            var serverName = "";
            var socketData = [];
            var isHost = false;
            var hasHostGlobal = false;
            socket.emit("GetSocketData");
            let sendForm = document.getElementById("MessageForm");
            let inputArea = document.getElementById("InputBox");

            let userNameInput = document.getElementById("UserNameInput");
            userNameInput.addEventListener("keydown", ()=> {
                userNameInput.style.backgroundColor = "white";
            });

            let UserNameDispalyText = document.getElementById("UsernameDisplay");
            let ServerNameDispalyText = document.getElementById("ServerNameDisplay");
            let HostNameDispalyText = document.getElementById("HostDisplay");
            let CustomGameForm = document.getElementById("CustomGameForm");
            let FullGameForm = document.getElementById("FullGameForm");
            let LevelsForm = document.getElementById("LevelsForm");
        
            let LevelButtons = document.getElementById("LevelButtons");
           
            let EmailForm = document.getElementById("EmailContainer");
            let severForm = document.getElementById("MakeServerForm");
            let serverText = document.getElementById("MakeServerInput");
            FullGameForm.addEventListener("submit", (event) => {
                event.defaultPrevented;
            });

            LevelsForm.addEventListener("submit", (event) => {
                event.defaultPrevented;
            });

            CustomGameForm.addEventListener("submit", (event) => {
                event.defaultPrevented;
            });
            socket.on("ChangeWebsite", ()=>{
                TestReplace();
            });

            socket.on("ShowReadyButton", ()=> {
                document.getElementById("ReadyButton").hidden = false;
            });
            socket.on("NextLevel", () =>{
                NextLevel();
            });
            
            socket.on("UpdatePlayerInfoText", () => {
                ShowOtherPlayerInfo();
            });

            socket.on("AnimateCardClientSide", (cards) => {
                console.log(cards);
                let waitTime = 0
                cards.forEach(card => {
                    AnimateCardFromOtherPlayer(card, waitTime);
                    waitTime += 500;
                });
            });


            async function StartFullGame() {
                await fetch("/startFullGame", {
                    method: "post"
                });
            }

            async function StartCustomGame() {
                let customCardAmount = document.getElementById("CustomCardRange").value;
                await fetch("/startCustomGame", {
                    method: "post",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({cardAmount:customCardAmount})

                });
            }

            async function StartGameFromLevel(level)
            {
                await fetch("/startGameFromLevel", {
                    method: "post",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({cardAmount:level})

                });
            }

            async function TestReplace()
            {
                const fileURL = "/MainPageHTMLText.txt";
                await fetch(fileURL).then(r => r.text()).then(text => {
                    document.getElementById("MainBody").style.backgroundColor = "wheat";
                    document.getElementById("MainBodyContents").innerHTML = text;
                    SetCardElements();
                });
            }

            async function ReplaceWithMainMenu()
            {
                ResetCardStatus();
                const fileURL = "/MenuScreenHTMLText.txt";
                await fetch(fileURL).then(r => r.text()).then(text => {
                    document.getElementById("MainBody").style.backgroundColor = "white";
                    document.getElementById("MainBodyContents").innerHTML = text;
                });
                await socket.emit("GetSocketData");
                SetWinText();
                await RestateElements();

                await SetIniztailInfoAfterGame();
            }

            async function RestateElements() 
            {
                sendForm = document.getElementById("MessageForm");
                inputArea = document.getElementById("InputBox");

                userNameInput = document.getElementById("UserNameInput");
                userNameInput.addEventListener("keydown", ()=> {
                    userNameInput.style.backgroundColor = "white";
                });

                UserNameDispalyText = document.getElementById("UsernameDisplay");
                ServerNameDispalyText = document.getElementById("ServerNameDisplay");
                HostNameDispalyText = document.getElementById("HostDisplay");
                CustomGameForm = document.getElementById("CustomGameForm");
                FullGameForm = document.getElementById("FullGameForm");
                LevelsForm = document.getElementById("LevelsForm");
            
                LevelButtons = document.getElementById("LevelButtons");
            
                EmailForm = document.getElementById("EmailContainer");
                severForm = document.getElementById("MakeServerForm");
                serverText = document.getElementById("MakeServerInput");
                FullGameForm.addEventListener("submit", (event) => {
                    event.defaultPrevented;
                });

                LevelsForm.addEventListener("submit", (event) => {
                    event.defaultPrevented;
                });

                CustomGameForm.addEventListener("submit", (event) => {
                    event.defaultPrevented;
                });
            }

            serverText.addEventListener("keydown", ()=>{
                serverText.style.backgroundColor = "white";
            });
            
            inputArea.placeholder  = "Enter your messages here";
            
            function UpdateCardsLeft()
            {
                socket.emit("SetCardsLeft", (GetCardsLeft()));
            }

            function AddPlayedCard(cardPlayed)
            {
                 
                socket.emit("AddPlayedCard", (cardPlayed));
                
            }
            //Sends email to desired people
            function AddEmail()
            {
                const emailInput = document.getElementById("EmailInput");
                const tempElement = document.createElement("li");
                tempElement.appendChild(document.createTextNode(emailInput.value));
                emailInput.value = "";
                document.getElementById("Emails").appendChild(tempElement);
            }

            async function SendEmailInvite()
            {
                if(isHost == false && hasHostGlobal == true)
                {
                    return;
                }
                var canSend = true;
                console.log(canSend);
                const EmailBody = document.getElementById("EmailBody");
                await fetch("/GetHostName").then(response => response.json()).then(HostNameJson => {
                    if(HostNameJson.Host == "")
                    {
                        EmailBody.value = "";
                        EmailBody.placeholder = "You have to be a host of a server to send invites.";   
                        canSend = false;
                    }
                });
                console.log(canSend);
                if(!canSend)
                {
                    return;
                }

                const emailList = document.getElementById("Emails");
                let emails = "";
                let totalEmails = emailList.childElementCount;
                for(let i = 0; i < totalEmails; i++)
                {
                    emails += emailList.children[i].innerText;
                    if(i < totalEmails - 1)
                    {
                        emails += ", ";
                    }   
                }
                let subject = `Invitation to join ${userName}'s game on ${serverName} Server`;
                let uri = socket.io.uri;
                let body = `${EmailBody.value}\nClick here to join ${userName}'s game: ${uri}`;
                body = encodeURIComponent(body);
                console.log(emails);
                console.log(subject);
                console.log(body);
                window.open(`mailto:${emails}?subject=${subject}&body=${body}`);
                EmailBody.value = "";
                EmailBody.placeholder = "Invites Sent!";   
            }

            function SetPersonalInfoFront()
                {
                    fetch("/SetPersonalInfo", {
                        method: "post",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({Email:"poppy.rivers", Password:"newPass", Username:userName})
                    });
                }


           
            socket.on("RecieveSocketData", (sentsocketData) => {
                socketData = sentsocketData;
                console.log(socketData);
            });

            function ShowSearches()
            {
                document.getElementById("SearchResults").classList.toggle("show");
            }

            function SetUserName()
            {
                userName = userNameInput.value;
                userNameInput.value = "";
                socket.emit("SetUserName", userName);
            }

            function GetUserNameClientSide()
            {
                return socketData.userName;
            }

            //The server, username, and hostname text setter
            function SetInfoText()
            {
                SetUserNameText();
                SetServerNameText();
                SetHostText();
            }

            function SetUserNameText()
            {
                console.log("Setting username")
                let newUserText = "Username: nothing";
                if(userName != "")
                {
                    newUserText = `Username: ${userName}`;
                }

                UserNameDispalyText.innerText = newUserText;
            }

            async function SetServerNameBackEnd(serverNameSent)
            {   
                socket.emit("MakeHost");
                let ServerNameData = {ServerN:serverNameSent};
                await fetch("/SetServerNameServerSide", {
                    method: "post",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ServerNameData)
                }).then(SetServerNameText());

            }

            function SetServerNameText()
            {  
                console.log("Setting server name");
                fetch("/GetServerName").then(response => response.json()).then(serverData => {
                    console.log(serverData);
                    serverName = serverData.ServerN;
                    let newServerText = `Server name: ${serverData.ServerN}`;
                    if(serverName == "")
                    {
                        newServerText = `Server name: Nothing`;
                    }
                    ServerNameDispalyText.innerText = newServerText;
                });
            }
            
            async function SetHostNameBackEnd()
            {
                let HostNameData = {hostName:userName};
                await fetch("/SetHostNameServerSide", {
                    method: "post",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(HostNameData)
                }).then(SetHostText());
            }
            

            function SetHostText()
            {
                console.log("Setting host name");
                fetch("/GetHostName").then(response => response.json()).then(hostData => {
                    hostName = hostData.Host;
                    let newHostText = `Host name: ${hostData.Host}`;
                    if(hostName == "")
                    {
                        newHostText = `Host name: Nothing`;
                    }else if(hostName != userName)      
                    {
                        severForm.hidden = true;
                        EmailForm.hidden = true;
                    }

                    HostNameDispalyText.innerText = newHostText;
                    
                });
            }
            
            function SerachServers(ServersAvalible)
            {
                const SearchBar = document.getElementById("SearchBar");
                let inputSearch = SearchBar.value.toLowerCase();
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
                ServersAvalible.forEach(server => {
                    let serverName = server.ServerName;
                    if(serverName.trim().toLowerCase().indexOf(inputSearch) > -1)
                    {
                        const tempButton = document.createElement("button");
                        tempButton.innerText = serverName;
                        tempButton.addEventListener("click", function() {
                            ChangeServer(serverName);
                        });
                        SearchResults.append(tempButton);
                    }
                });
            }
            
            async function ChangeReadyStatus()
            {
                await socket.emit("ChangeReadyStatus");
                await socket.emit("GetSocketData");
            }

            async function CheckForStartGame() {
                ChangeReadyStatus();
                if(socketData.isReady)
                {
                    document.getElementById("ReadyButton").innerText = "Click to ready up";
                }else
                {
                    document.getElementById("ReadyButton").innerText = "You're ready!";
                }
                await fetch("/CheckForChangeToGame",{ 
                    method: "post"
                   }
                );
            }

            function ClearSearch()
            {
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
                document.getElementById("SearchBar").value = "";

            }

            /*function GetServersForSearch()
            {
                fetch("/ShowServers").then(response =>{return response.json();})
                .then(Servers => {
                    SerachServers(Servers);
                });
              
            }*/
            
            async function SetServerName()
            {
                if(isHost == false && hasHostGlobal == true)
                {
                    return;
                }
                console.log(userName);
                if(userName == "")
                {
                    serverText.value = "";
                    serverText.placeholder = "You need to set a username before you make a server";
                    return;
                }
                let newServerName = serverText.value.trim().toLowerCase();
                let serverNameSent = serverText.value;

                if(newServerName == "")
                {
                    serverText.value = "";
                    serverText.placeholder = "You can't have nothing as your server name dumba**";
                    serverText.style.backgroundColor = "red";
                    return;
                }

                
                serverName = serverNameSent;

                SetServerNameBackEnd(serverNameSent);
                SetHostNameBackEnd();
                

                isHost = true;
                CustomGameForm.hidden = false;
                FullGameForm.hidden = false;
                LevelButtons.hidden = false;
                serverText.value = "";

                socket.emit("GetMessageReady", "joined");

            }

            /*

            function GetServersForCheck()
            {
                fetch("/ShowServers").then(response =>{return response.json();})
                .then(Servers => {
                    ServerTaken(Servers);
                });
            }
            
            function ServerTaken(ServersAvalible)
            {
                if(userName == "")
                {
                    serverText.value = "";
                    serverText.placeholder = "You need to set a username before you make a server";
                    return;
                }
                let newServerName = serverText.value.trim().toLowerCase();
                let servenNameSent = serverText.value;
                serverText.value = "";
                if(newServerName == "")
                {
                    serverText.placeholder = "You can't have nothing as your server name dumba**";
                    serverText.style.backgroundColor = "red";
                    return;
                }
                for(let i = 0; i < ServersAvalible.length; i++)
                {
                    let server = ServersAvalible[i];
                    if(server.ServerName.trim().toLowerCase() == newServerName)
                    {
                        serverText.placeholder = `${newServerName} is taken, try another name`;
                        serverText.style.backgroundColor = "red";
                        return;
                    }
                }

                serverText.placeholder = `${newServerName} is avliable, enjoy!`;
                serverText.style.backgroundColor = "green";
                serverName = servenNameSent;
                socket.emit("MakeServer", servenNameSent, socket.io.uri, userName);
                socket.emit("ShowPastMessages");
                socket.emit("GetMessageReady", "joined");
            }
F
            function ChangeServer(newServerName)
            {
                socket.emit("ChangeServer", newServerName);
            }

            */
            sendForm.addEventListener("submit", (event) => {
                event.preventDefault();
                if(inputArea.value.trim() != "")
                {
                    let inputValue = inputArea.value
                    inputArea.value = "";
                    console.log(socketData);
                    
                    if(userName == "")
                    {
                        inputArea.placeholder = "Make a username first, then a server";
                        return;
                    }                       
                    
                    if(serverName == "")
                    {
                        inputArea.placeholder = "Create or join a server before you join."
                        return;
                    }
                    socket.emit("GetMessageReady", inputValue);

                }
            });

                socket.on("GetCardsLeft", () => {
                    
                });

                socket.on("Message", (message, clientId) => {
                    console.log(hasHostGlobal);                    
                    let textEle = document.createElement('p');
                    console.log(message);
                  
                    textEle.innerText = message;
                    if(clientId == socket.id)
                    {
                        textEle.style.textAlign = "right";
                    }
                    document.getElementById("MessageBox").append(textEle);
                    document.getElementById("MessageBox").scrollTop = document.getElementById("MessageBox").scrollHeight;
                    inputArea.placeholder  = "Enter Your Message Here";
                    inputArea.value = "";
                });
                
                socket.on("UserNameFree", (hasHost)=>{
                    if(hasHost)
                    {
                        socket.emit("ShowPastMessages", GetUserNameClientSide());
                        socket.emit("GetMessageReady", "joined");
                    }
                    SetUserNameText();
                    SetHostText();
                    userNameInput.placeholder  = `${userName} is your username now! Enjoy!`;
                    userNameInput.style.backgroundColor = "green";
                });
                
                socket.on("UserNameTaken", ()=>{
                    let userNameHolder = userName;
                    userName = "";
                    userNameInput.placeholder  = `${userNameHolder} is taken, please input a different name`;
                    userNameInput.style.backgroundColor = "red";

                });

                socket.on("HostChanged", ()=>{
                    SetHostText();
                });
                
                socket.on("ConnectToNewServer", (uri) =>{
                    const newUrl = uri;
                    document.getElementById("MessageBox").replaceChildren();
                    socket.disconnect();
                    socket = io(newUrl);
                    console.log(newUrl);
                    window.location.href = newUrl;
                    ServerNameDispalyText.innerText = `Server name: ${serverName}`;
                    
                });
                
                socket.on("ShowPlayButton", () => {
                    document.getElementById("PlayButton").hidden = false;
                });

                socket.on("HidePlayButton", () => {
                    document.getElementById("PlayButton").hidden = false;
                });

                async function SetHasHost()
                {
                    await fetch("/getHasHost").then(response => response.json()).then(HasHostData => {
                        console.log(HasHostData);
                        hasHostGlobal = HasHostData.HasHost;
                       
                    });
                }
                
                
                async function SetIniztailInfoAfterGame()
                {
                    SetInfoText();
                    SetHasHost();
                    console.log(socketData);   
                    if(socketData.isHost)
                    {
                        isHost = true;
                        ShowHostElements();
                    }else
                    {
                        HideHostElements();
                    }
                    socket.emit("ShowPastMessages", GetUserNameClientSide());
                }

                function ShowHostElements()
                {
                    CustomGameForm.hidden = false;
                    FullGameForm.hidden = false;
                    LevelButtons.hidden = false;
                    severForm.hidden = false;
                    EmailForm.hidden = false;
                }

                function HideHostElements()
                {
                    CustomGameForm.hidden = true;
                    FullGameForm.hidden = true;
                    LevelButtons.hidden = true;
                    severForm.hidden = true;
                    EmailForm.hidden = true;
                }

                SetInfoText();
                SetHasHost();
                

                
        </script>
    </body>
</html>