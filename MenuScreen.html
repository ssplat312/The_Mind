<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/GeneralStyles.css">
    </head>
    <body>
        <form action="/startCustomGame" method="post">
            <label for="cardAmount">Choose the amount of cards you want</label>
            <input type="range" min="1" max="100" value="1" name="cardAmount" oninput="this.nextElementSibling.value = this.value">
            <output>1</output>
            <input type="submit" value="Create Game">
        </form>
        <form action="/startGameFromLevel" method="post">
            <div id="LevelButtons">
                <label for="cardAmount">What level do you want to play?</label>
                <button  type="submit" name="cardAmount" value="10">Level 10</button>
                <button  type="submit" name="cardAmount" value="9">Level 9</button>
                <button  type="submit" name="cardAmount" value="8">Level 8</button>
                <button  type="submit" name="cardAmount" value="7">Level 7</button>
                <button  type="submit" name="cardAmount" value="6">Level 6</button>
                <button  type="submit" name="cardAmount" value="5">Level 5</button>
                <button  type="submit" name="cardAmount" value="4">Level 4</button>
                <button  type="submit" name="cardAmount" value="3">Level 3</button>
                <button  type="submit" name="cardAmount" value="2">Level 2</button>
                <button  type="submit" name="cardAmount" value="1">Level 1</button>
            </div>
        </form> 
        <form action="/startFullGame" method="post">
            <label for="cardAmount">Click here to play a full run</label>
            <button type="submit" name="cardAmount" value="1">Start Run</button>
        </form>
        <p id="WinStatus">Win text goes here</p>

        <form id="ServerForm">
            <label>Enter a server Name here</label>
            <input type="text" placeholder="Enter server name here" id="ServerInput">
            <input type="submit" value="Make new server" name="MakeServer">
            <input type="submit" value="Join a server" name="JoinServer">
        </form>
        <input id="SearchBar" onkeyup="GetServers()" onfocus="GetServers()" onfocusout="ClearSearch()" placeholder="Search Servers">
        <div id="SearchResults">

        </div>
        <div id="MessageBox">
        </div>

        <form id="MessageForm">
            <input type="text" id="InputBox"  value="">
            <input type="submit"  value="Send" style="transform: translate(50%, 50%); margin-top: 8%; margin-left: 7%;">
        </form>
        <form>
            <input type="">
        </form>
        <button type="button" onclick="ShowServers()">See Servers</button>
       <script src="/SetupWinText.js"></script>
       <script src = "/socket.io/socket.io.js"></script>
        <script>
            console.log(window.location.hostname);
            console.log(window.location.host);
            let socket = io();
            console.log(socket.io.uri);
            var userName = "";
            const sendForm = document.getElementById("MessageForm");
            const inputArea = document.getElementById("InputBox");
            const severForm = document.getElementById("ServerForm");
            const serverText = document.getElementById("ServerInput");
            inputArea.placeholder  = "Enter your username here";


            function SerachServers(ServersAvalible)
            {
                const SearchBar = document.getElementById("SearchBar");
                let inputSearch = SearchBar.value.toLowerCase();
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
                ServersAvalible.forEach(server => {
                    let serverName = server.ServerName;
                    if(serverName.trim().toLowerCase().indexOf(inputSearch) > -1)
                    {
                        const tempButton = document.createElement("button");
                        tempButton.innerText = serverName;
                        //tempButton.onclick();
                        SearchResults.append(tempButton);
                    }
                });
            }
            
            function ClearSearch()
            {
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
            }

            function GetServers()
            {
                fetch("/ShowServers").then(response =>{return response.json();})
                .then(Servers => {
                    SerachServers(Servers);
                });
              
            }

            severForm.addEventListener("submit", (event) =>{
                console.log(event.submitter);
                event.preventDefault();
                if(event.submitter.name == "MakeServer")
                {
                    socket.emit("MakeServer", serverText.value, socket.io.uri, "Ssplat");
                }else
                {
                    socket.emit("ChangeServer", serverText.value);
                }
                serverText.value = "";


            });

            sendForm.addEventListener("submit", (event) => {
                event.preventDefault();
                if(inputArea.value.trim() != "")
                {

                    if(userName == "")
                    {
                        userName = inputArea.value;
                        inputArea.value = "";
                        socket.emit("SetUserName", userName);
                        return;
                    }                       
                    
                    socket.emit("GetMessageReady", inputArea.value);
                    inputArea.value = "";
                }
            });

            

                socket.on("Message", (message, clientId) => {
                    textEle = document.createElement('p');
                    console.log(message);
                    textEle.innerText = message;
                    if(clientId == socket.id)
                    {
                        textEle.style.textAlign = "right";
                    }
                    document.getElementById("MessageBox").append(textEle);
                    document.getElementById("MessageBox").scrollTop = document.getElementById("MessageBox").scrollHeight;
                    inputArea.placeholder  = "Enter Your Message Here";
                });
                
                socket.on("UserNameFree", ()=>{
                    socket.emit("ShowPastMessages");
                    socket.emit("GetMessageReady", "joined");
                    inputArea.placeholder  = "Enter Your Message Here";
                });
                
                socket.on("UserNameTaken", ()=>{
                    let userNameHolder = userName;
                    userName = "";
                    inputArea.placeholder  = `${userNameHolder} is taken, please input a different name`;

                });
                
                socket.on("ConnectToNewServer", (uri) =>{
                    console.log(uri);
                    const newUrl = uri;
                    document.getElementById("MessageBox").replaceChildren();
                    socket.disconnect();
                    socket = io(newUrl);
                    console.log(newUrl);
                    window.location.href = newUrl;
                });
                
                
        </script>
    </body>
</html>