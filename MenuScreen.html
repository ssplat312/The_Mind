<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/GeneralStyles.css">
    </head>
    <body>
        <form action="/startCustomGame" method="post">
            <label for="cardAmount">Choose the amount of cards you want</label>
            <input type="range" min="1" max="100" value="1" name="cardAmount" oninput="this.nextElementSibling.value = this.value">
            <output>1</output>
            <input type="submit" value="Create Game">
        </form>
        <form action="/startGameFromLevel" method="post">
            <div id="LevelButtons">
                <label for="cardAmount">What level do you want to play?</label>
                <button  type="submit" name="cardAmount" value="10">Level 10</button>
                <button  type="submit" name="cardAmount" value="9">Level 9</button>
                <button  type="submit" name="cardAmount" value="8">Level 8</button>
                <button  type="submit" name="cardAmount" value="7">Level 7</button>
                <button  type="submit" name="cardAmount" value="6">Level 6</button>
                <button  type="submit" name="cardAmount" value="5">Level 5</button>
                <button  type="submit" name="cardAmount" value="4">Level 4</button>
                <button  type="submit" name="cardAmount" value="3">Level 3</button>
                <button  type="submit" name="cardAmount" value="2">Level 2</button>
                <button  type="submit" name="cardAmount" value="1">Level 1</button>
            </div>
        </form> 
        <form action="/startFullGame" method="post">
            <label for="cardAmount">Click here to play a full run</label>
            <button type="submit" name="cardAmount" value="1">Start Run</button>
        </form>
        <p id="WinStatus">Win text goes here</p>

        <div id="MakeServerForm">
            <p>Enter a server Name here</p>
            <input type="text" placeholder="Enter server name here" id="MakeServerInput">
            <input type="button" value="Make new server" name="MakeServer" onclick="GetServersForCheck()">
        </div>
        <div id="UserNameMaker">
            <input type="text" id="UserNameInput" placeholder="Enter the username you want to use here.">
            <button onclick="SetUserName()">Set Username</button>
        </div>
        <div id="SearchDropdown">
            <button id="DropdownButton" onclick="ClearSearch()">Clear Search</button>
            <div id="SearchMenu" class="SearchContents">
                <input type="text" id="SearchBar" onkeyup="GetServersForSearch()" onfocus="GetServersForSearch()" placeholder="Search Servers">
                <div id="SearchResults">
                    
                </div>
            </div>
        </div>
        <div id="MessageBox">
        </div>

        <form id="MessageForm">
            <input type="text" id="InputBox"  value="">
            <input type="submit"  value="Send" style="transform: translate(50%, 50%); margin-top: 8%; margin-left: 7%;">
        </form>
        <form>
            <input type="">
        </form>
       <script src="/SetupWinText.js"></script>
       <script src = "/socket.io/socket.io.js"></script>
        <script>
            let socket = io();
            var userName = "";
            var serverName = "";
            var socketData = [];
            socket.emit("GetSocketData");
            const sendForm = document.getElementById("MessageForm");
            const inputArea = document.getElementById("InputBox");
            const userNameInput = document.getElementById("UserNameInput");
            userNameInput.addEventListener("keydown", ()=> {
                userNameInput.style.backgroundColor = "white";
            });

            const severForm = document.getElementById("MakeServerForm");
            const serverText = document.getElementById("MakeServerInput");
            serverText.addEventListener("keydown", ()=>{
                serverText.style.backgroundColor = "white";
            });
            inputArea.placeholder  = "Enter your messages here";
            
            socket.on("RecieveSocketData", (sentsocketData) => {
                socketData = sentsocketData;
                console.log(socketData);
            });

            function ShowSearches()
            {
                document.getElementById("SearchResults").classList.toggle("show");
            }

            function SetUserName()
            {
                userName = userNameInput.value;
                userNameInput.value = "";
                socket.emit("SetUserName", userName);
            }

            function SerachServers(ServersAvalible)
            {
                const SearchBar = document.getElementById("SearchBar");
                let inputSearch = SearchBar.value.toLowerCase();
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
                ServersAvalible.forEach(server => {
                    let serverName = server.ServerName;
                    if(serverName.trim().toLowerCase().indexOf(inputSearch) > -1)
                    {
                        const tempButton = document.createElement("button");
                        tempButton.innerText = serverName;
                        tempButton.addEventListener("click", function() {
                            ChangeServer(serverName);
                        });
                        SearchResults.append(tempButton);
                    }
                });
            }
            
            function ClearSearch()
            {
                const SearchResults = document.getElementById("SearchResults");
                SearchResults.replaceChildren();
                document.getElementById("SearchBar").value = "";

            }

            function GetServersForSearch()
            {
                fetch("/ShowServers").then(response =>{return response.json();})
                .then(Servers => {
                    SerachServers(Servers);
                });
              
            }

            function GetServersForCheck()
            {
                fetch("/ShowServers").then(response =>{return response.json();})
                .then(Servers => {
                    ServerTaken(Servers);
                });
            }
            
            function ServerTaken(ServersAvalible)
            {
                if(userName == "")
                {
                    serverText.value = "";
                    serverText.placeholder = "You need to set a username before you make a server";
                    return;
                }
                let newServerName = serverText.value.trim().toLowerCase();
                let servenNameSent = serverText.value;
                serverText.value = "";
                if(newServerName == "")
                {
                    serverText.placeholder = "You can't have nothing as your server name dumba**";
                    serverText.style.backgroundColor = "red";
                    return;
                }
                for(let i = 0; i < ServersAvalible.length; i++)
                {
                    let server = ServersAvalible[i];
                    if(server.ServerName.trim().toLowerCase() == newServerName)
                    {
                        serverText.placeholder = `${newServerName} is taken, try another name`;
                        serverText.style.backgroundColor = "red";
                        return;
                    }
                }

                serverText.placeholder = `${newServerName} is avliable, enjoy!`;
                serverText.style.backgroundColor = "green";
                serverName = servenNameSent;
                socket.emit("MakeServer", servenNameSent, socket.io.uri, "Ssplat");
                socket.emit("ShowPastMessages");
                socket.emit("GetMessageReady", "joined");
            }

            function ChangeServer(newServerName)
            {
                socket.emit("ChangeServer", newServerName);
            }

        
            sendForm.addEventListener("submit", (event) => {
                event.preventDefault();
                if(inputArea.value.trim() != "")
                {
                    let inputValue = inputArea.value
                    console.log(socketData);
                    
                    if(userName == "")
                    {
                        inputArea.placeholder = "Make a username first, then a server";
                        return;
                    }                       
                    
                    if(serverName == "")
                    {
                        inputArea.placeholder = "Create or join a server before you join."
                    }
                    socket.emit("GetMessageReady", inputValue);
                }
            });

            

                socket.on("Message", (message, clientId) => {
                    textEle = document.createElement('p');
                    console.log(message);
                    textEle.innerText = message;
                    if(clientId == socket.id)
                    {
                        textEle.style.textAlign = "right";
                    }
                    document.getElementById("MessageBox").append(textEle);
                    document.getElementById("MessageBox").scrollTop = document.getElementById("MessageBox").scrollHeight;
                    inputArea.placeholder  = "Enter Your Message Here";
                    inputArea.value = "";
                });
                
                socket.on("UserNameFree", (hasHost)=>{
                    if(hasHost)
                    {
                        socket.emit("ShowPastMessages");
                        socket.emit("GetMessageReady", "joined");
                    }
                    userNameInput.placeholder  = `${userName} is your username now! Enjoy!`;
                    userNameInput.style.backgroundColor = "green";
                });
                
                socket.on("UserNameTaken", ()=>{
                    let userNameHolder = userName;
                    userName = "";
                    userNameInput.placeholder  = `${userNameHolder} is taken, please input a different name`;
                    userNameInput.style.backgroundColor = "red";

                });
                
                socket.on("ConnectToNewServer", (uri) =>{
                    const newUrl = uri;
                    document.getElementById("MessageBox").replaceChildren();
                    socket.disconnect();
                    socket = io(newUrl);
                    console.log(newUrl);
                    window.location.href = newUrl;
                });
                
                
        </script>
    </body>
</html>